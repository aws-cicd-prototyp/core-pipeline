---
# TODO consistent tagging
# TODO outputs
# TODO CF Stack Deletion and assumed roles
# TODO permissions permissions permissions
# TODO Setup user roles and check security issues
# TODO Manage CF outputs in SSM
AWSTemplateFormatVersion: 2010-09-09
Description: Cloudformation-Stack for the core code pipeline. This stack is created in the DevOps Account.

Parameters:
  RemoteAccountTest:
    Description: The remote workload account ID
    Type: String
  BaseStack:
    Description: Base CF stack to import references from
    Type: String

Resources:
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CodeBuildServiceRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Path: /
  CodeBuildServiceRolePolicy:
    Type: AWS::IAM::Policy
    DependsOn: CodeBuildServiceRole
    Properties:
      PolicyName: CodeBuildServiceRolePolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Resource: "*"
            Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
          -
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:Encrypt
              - kms:GenerateDataKey
            Resource: 
              Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsKeyArn"
          -
            Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetBucketPolicy
              - s3:GetObject
              - s3:ListBucket
              - s3:GetObjectVersion
              - s3:GetBucketVersioning
              - s3:ListBucketVersions
              - s3:GetObjectVersionTagging
            Resource:
              - Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
              - Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
                  - '/*'
          -
            Effect: Allow
            Action:
              - sts:AssumeRole
            Resource: 
              - !Sub arn:aws:iam::${RemoteAccountTest}:role/CrossAccountCoreRole
          -
            Effect: Allow
            Action:
              - codepipeline:*
              - iam:ListRoles
              - codecommit:List*
              - codecommit:Get*
              - codecommit:GitPull
              - codecommit:UploadArchive
              - codecommit:CancelUploadArchive
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - iam:PassRole
              - s3:*
              - cloudformation:*
              - iam:* # TODO refine permissions 
            Resource:
              - "*"            
          -
            Effect: Allow
            Action:
              - ssm:GetParameter
              - ssm:GetParameters
            Resource:
              # TODO necessary here?
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/GitHubOauthToken"
      Roles:
        - !Ref CodeBuildServiceRole                

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    DependsOn:
      - CodeBuildServiceRole
    Properties:
      Artifacts:
        Type: S3
        Name: core-pipeline.zip
        Packaging: ZIP
        Location: 
          Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket" # TODO use a separate bucket???
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2
          env:
            variables:
              PROJECT: "Enter the name of Git project"
              REPOSITORY: "ENTER_A_NAME"
              BRANCH: "ENTER_A_BRANCH"
              STAGE: "ENTER_A_STAGE"
              ARTIFACT_BUCKET: "Artifact Bucket"
              PIPELINE_ROLE_ARN: "Pipeline role ARN"
              PIPELINE_DEPLOY_ROLE_ARN: "Pipeline deploy role ARN"
              PIPELINE_KMS_KEY_ARN: "Pipeline KMS key ARN"
              REMOTE_ACCOUNT_ID: "Remote workload account id"
              DEV_OPS_ACCOUNT_ID: "DevOps account id"
            git-credential-helper: yes
          phases:
            pre_build:
              commands:
                - ls -lah
                - git clone https://github.com/${PROJECT}/${REPOSITORY}.git
                - cd $REPOSITORY
                - ls -lah
                - git checkout $BRANCH
                - ls -lah
                - cp build/pipeline-${STAGE}.json build/pipeline.json
                - cp build/cross-account-roles-${STAGE}.json build/cross-account-roles.json
                - |
                  cat <<EOF > pipeline_env.json
                  {
                    "ArtifactBucket": "${ARTIFACT_BUCKET}",
                    "PipelineRoleArn": "${PIPELINE_ROLE_ARN}",
                    "PipelineDeployRoleArn": "${PIPELINE_DEPLOY_ROLE_ARN}",
                    "PipelineKmsKeyArn": "${PIPELINE_KMS_KEY_ARN}",
                    "Branch": "${BRANCH}",
                    "Stage": "${STAGE}",
                    "Project": "${PROJECT}",
                    "Repository": "${REPOSITORY}",
                    "RemoteAccount": "${REMOTE_ACCOUNT_ID}",
                    "DevOpsAccount": "${DEV_OPS_ACCOUNT_ID}"
                  }
                  EOF
          artifacts:
            base-directory: ${REPOSITORY}
            files:
              - build/pipeline.yaml
              - build/pipeline.json
              - build/cross-account-roles.yaml
              - build/cross-account-roles.json
              - pipeline_env.json
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:3.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: STAGE
            Value: test
          - Name: PROJECT
            Value: Enter the name of Git project
          - Name: REPOSITORY
            Value: Provide the name of the repository
          - Name: BRANCH
            Value: Provide the branch
          - Name: ARTIFACT_BUCKET
            Value: 
              Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
          - Name: PIPELINE_ROLE_ARN
            Value: !GetAtt PipeLineRole.Arn
          - Name: PIPELINE_DEPLOY_ROLE_ARN
            Value: !GetAtt PipelineDeployRole.Arn
          - Name: PIPELINE_KMS_KEY_ARN
            Value: 
              Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsKeyArn"
          - Name: REMOTE_ACCOUNT_ID
            Value: !Ref RemoteAccountTest
          - Name: DEV_OPS_ACCOUNT_ID
            Value: !Ref AWS::AccountId

      Name: "CreateUpdateBuildPipeline"
      ServiceRole: !Ref CodeBuildServiceRole


  PipeLineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CoreCodepipelineRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  PipelinePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CoreCodepipelinePolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action:
              - codepipeline:*
              - iam:ListRoles
              - cloudformation:Describe*
              - cloudFormation:List*
              - codecommit:List*
              - codecommit:Get*
              - codecommit:GitPull
              - codecommit:UploadArchive
              - codecommit:CancelUploadArchive
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - cloudformation:CreateStack
              - cloudformation:DeleteStack
              - cloudformation:DescribeStacks
              - cloudformation:UpdateStack
              - cloudformation:CreateChangeSet
              - cloudformation:DeleteChangeSet
              - cloudformation:DescribeChangeSet
              - cloudformation:ExecuteChangeSet
              - cloudformation:SetStackPolicy
              - cloudformation:ValidateTemplate
              - iam:PassRole
              - s3:ListAllMyBuckets
              - s3:GetBucketLocation
            Resource:
              - "*"
          -
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:Encrypt
              - kms:GenerateDataKey
            Resource: 
              Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsKeyArn"
          -
            Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetBucketPolicy
              - s3:GetObject
              - s3:ListBucket
              - s3:GetObjectVersion
              - s3:GetBucketVersioning
              - s3:ListBucketVersions
              - s3:GetObjectVersionTagging
            Resource:
              - Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
              - Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
                  - '/*'
          -
            Effect: Allow
            Action:
              - sts:AssumeRole
            Resource: 
              - !GetAtt PipelineDeployRole.Arn
              - !Sub arn:aws:iam::${RemoteAccountTest}:role/CrossAccountRole

      Roles:
        - !Ref PipeLineRole

  PipelineDeployRole:
    Type: AWS::IAM::Role
    DependsOn: PipeLineRole
    Properties:
      # TOTO better resource naming
      RoleName: CoreCodepipelineDeployRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  PipelineDeployPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CoreCodepipelineDeloyPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action:
              - codepipeline:*
              - iam:ListRoles
              - codecommit:List*
              - codecommit:Get*
              - codecommit:GitPull
              - codecommit:UploadArchive
              - codecommit:CancelUploadArchive
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - iam:PassRole
              - s3:*
              - cloudformation:*
              - iam:* # TODO refine permissions 
            Resource:
              - "*"
          -
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:Encrypt
              - kms:GenerateDataKey
            Resource: 
              Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsKeyArn"
          -
            Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetBucketPolicy
              - s3:GetObject
              - s3:ListBucket
              - s3:GetObjectVersion
              - s3:GetBucketVersioning
              - s3:ListBucketVersions
              - s3:GetObjectVersionTagging
            Resource:
              - Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
              - Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
                  - '/*'
          -
            Effect: Allow
            Action:
              - ssm:GetParameter
              - ssm:GetParameters
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/GitHubOauthToken"
      Roles:
        - !Ref PipelineDeployRole

  PipelineCloudWatchEventRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - events.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        -
          PolicyName: cwe-core-pipeline-execution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              -
                Effect: Allow
                Action: codepipeline:StartPipelineExecution
                Resource: !Join [ '', [ 'arn:aws:codepipeline:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':', !Ref Pipeline ] ]

  PipelineCloudWatchEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - 'AWS API Call via CloudTrail'
        detail:
          eventSource:
            - s3.amazonaws.com
          eventName:
            - CopyObject
            - PutObject
            - CompleteMultipartUpload
          requestParameters:
            bucketName:
              - Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
            key:
              - core-pipeline.zip
      Targets:
        -
          Arn:
            !Join [ '', [ 'arn:aws:codepipeline:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':', !Ref Pipeline ] ]
          RoleArn: !GetAtt PipelineCloudWatchEventRole.Arn
          Id: !Ref Pipeline

  # https://docs.aws.amazon.com/codepipeline/latest/userguide/create-cloudtrail-S3-source-cfn.html
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    DependsOn:
      - PipelinePolicy
      - PipeLineRole
    Properties:
      RoleArn: !GetAtt PipeLineRole.Arn
      Name: !Ref AWS::StackName
      RestartExecutionOnUpdate: false
      ArtifactStore:
        Location: 
          Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
        Type: S3
        EncryptionKey: 
          Type: KMS
          Id: 
            Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsAlias"
      Stages:
        - Name: Source
          Actions:
            - Name: Source
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: 1
                Provider: S3
              Configuration: 
                S3Bucket: 
                  Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
                S3ObjectKey: core-pipeline.zip
                PollForSourceChanges: false
              OutputArtifacts: 
                - Name: SourceOutput 
              RunOrder: 1
        - Name: CreateCrossAccountRoles
          Actions:
            - Name: CreateCrossAccountRoles
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref CreateUpdateCrossAccountRoles
              InputArtifacts:
                - Name: SourceOutput
              RunOrder: 1 
        - Name: CreateProjectPipeline
          Actions:
            - Name: CreateProjectPipeline
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref CreateUpdateProjectPipelineBuild
              InputArtifacts:
                - Name: SourceOutput
              RunOrder: 1 


  # TODO don't start on update  
  CreateUpdateCrossAccountRoles:
    Type: AWS::CodeBuild::Project
    DependsOn:
      - CodeBuildServiceRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        # TODO cleanup BRANCH name
        BuildSpec: |
          version: 0.2
          env:
            variables:
              ARTIFACT_BUCKET: "Artifact Bucket"
              PIPELINE_KMS_KEY_ARN: "Pipeline KMS key ARN"
              DEV_OPS_ACCOUNT_ID: "DevOps account id"
              REMOTE_ACCOUNT_ID: "Remote workload accout ID"
          phases:
            pre_build:
              commands:
                - cd $CODEBUILD_SRC_DIR
                - export PROJECT=$(cat pipeline_env.json | jq -r ".Project")
                - export REPOSITORY=$(cat pipeline_env.json | jq -r ".Repository")
                - export BRANCH=$(cat pipeline_env.json | jq -r ".Branch")
                - export BRANCH_NAME=$BRANCH
                - export STAGE=$(cat pipeline_env.json | jq -r ".Stage")
                - CREDENTIALS=$(aws sts assume-role --role-arn arn:aws:iam::${REMOTE_ACCOUNT_ID}:role/CrossAccountCoreRole --role-session-name "AssumeRole-${PROJECT}-${REPOSITORY}")
                - export AWS_ACCESS_KEY_ID=$(echo $CREDENTIALS | jq -r ".Credentials.AccessKeyId")
                - export AWS_SECRET_ACCESS_KEY=$(echo $CREDENTIALS | jq -r ".Credentials.SecretAccessKey")
                - export AWS_SESSION_TOKEN=$(echo $CREDENTIALS | jq -r ".Credentials.SessionToken")
                - STACKS=$(aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE ROLLBACK_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE IMPORT_COMPLETE IMPORT_ROLLBACK_COMPLETE)
                - STACKS_COUNT=$(echo $STACKS | jq --arg stack "ca-roles-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}" '.StackSummaries[] | select(.StackName==$stack) | .StackId' | jq --slurp '. | length') 
                - |
                  if [ $STACKS_COUNT = "0" ]
                  then
                    aws cloudformation create-stack \
                      --stack-name "ca-roles-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}" \
                      --template-body file://build/cross-account-roles.yaml \
                      --parameters \
                        ParameterKey=DevOpsAccount,ParameterValue=${DEV_OPS_ACCOUNT_ID} \
                        ParameterKey=ArtifactBucket,ParameterValue=${ARTIFACT_BUCKET} \
                        ParameterKey=PipelineKmsKeyArn,ParameterValue=${PIPELINE_KMS_KEY_ARN} \
                        ParameterKey=Branch,ParameterValue=${BRANCH} \
                        ParameterKey=Stage,ParameterValue=${STAGE} \
                      --capabilities CAPABILITY_NAMED_IAM
                    aws cloudformation wait stack-create-complete --stack-name "ca-roles-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}"
                  else
                    aws cloudformation create-change-set \
                      --stack-name "ca-roles-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}" \
                      --template-body file://build/cross-account-roles.yaml \
                      --parameters \
                        ParameterKey=DevOpsAccount,ParameterValue=${DEV_OPS_ACCOUNT_ID} \
                        ParameterKey=ArtifactBucket,ParameterValue=${ARTIFACT_BUCKET} \
                        ParameterKey=PipelineKmsKeyArn,ParameterValue=${PIPELINE_KMS_KEY_ARN} \
                        ParameterKey=Branch,ParameterValue=${BRANCH} \
                        ParameterKey=Stage,ParameterValue=${STAGE} \
                      --capabilities CAPABILITY_NAMED_IAM \
                      --change-set-name "ca-roles-${CODEBUILD_START_TIME}" > change-set.json
                    CHANGE_SET_ID=$(cat change-set.json | jq -r '.Id')
                    CHANGE_SET=$(aws cloudformation describe-change-set --change-set-name $CHANGE_SET_ID)
                    CHANGE_SET_STATUS=$(echo $CHANGE_SET | jq -r '.Status')
                    if [ $CHANGE_SET_STATUS != "FAILED" ]
                    then
                      aws cloudformation wait change-set-create-complete --change-set-name $CHANGE_SET_ID 
                    fi
                    aws cloudformation describe-change-set --change-set-name $CHANGE_SET_ID > change-set-details.json 
                    CHANGES_COUNT=$(cat change-set-details.json |  jq '.Changes | length')
                    if [ $CHANGES_COUNT = "0" ]
                    then
                      aws cloudformation delete-change-set --change-set-name $CHANGE_SET_ID
                    else
                      aws cloudformation execute-change-set --change-set-name $CHANGE_SET_ID
                      aws cloudformation wait stack-update-complete --stack-name "ca-roles-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}"
                    fi
                  fi
          artifacts:
            base-directory: ${CODEBUILD_SRC_DIR}
            files:
              - change-set-details.json
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:3.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: ARTIFACT_BUCKET
            Value: 
              Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
          - Name: PIPELINE_KMS_KEY_ARN
            Value: 
              Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsKeyArn"
          - Name: DEV_OPS_ACCOUNT_ID
            Value: !Ref AWS::AccountId
          - Name: REMOTE_ACCOUNT_ID
            Value: !Ref RemoteAccountTest
      Name: CreateUpdateCrossAccountRoles
      ServiceRole: !Ref CodeBuildServiceRole

  # TODO Finalize roles and policies
  CreateUpdateProjectPipelineBuild:
    Type: AWS::CodeBuild::Project
    DependsOn:
      - CodeBuildServiceRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        # TODO cleanup BRANCH name
        BuildSpec: |
          version: 0.2
          env:
            variables:
              ARTIFACT_BUCKET: "Artifact Bucket"
              PIPELINE_KMS_KEY_ARN: "Pipeline KMS key ARN"
              DEV_OPS_ACCOUNT_ID: "DevOps account id"
              REMOTE_ACCOUNT_ID: "Remote workload accout ID"
          phases:
            pre_build:
              commands:
                - cd $CODEBUILD_SRC_DIR
                - export PROJECT=$(cat pipeline_env.json | jq -r ".Project")
                - export REPOSITORY=$(cat pipeline_env.json | jq -r ".Repository")
                - export BRANCH=$(cat pipeline_env.json | jq -r ".Branch")
                - export BRANCH_NAME=$BRANCH
                - export STAGE=$(cat pipeline_env.json | jq -r ".Stage")
                - STACKS=$(aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE ROLLBACK_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE IMPORT_COMPLETE IMPORT_ROLLBACK_COMPLETE)
                - STACKS_COUNT=$(echo $STACKS | jq --arg stack "pipeline-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}" '.StackSummaries[] | select(.StackName==$stack) | .StackId' | jq --slurp '. | length') 
                - |
                  if [ $STACKS_COUNT = "0" ]
                  then
                    aws cloudformation create-stack \
                      --stack-name "pipeline-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}" \
                      --template-body file://build/pipeline.yaml \
                      --parameters \
                        ParameterKey=RemoteAccount,ParameterValue=${REMOTE_ACCOUNT_ID} \
                        ParameterKey=ArtifactBucket,ParameterValue=${ARTIFACT_BUCKET} \
                        ParameterKey=PipelineKmsKeyArn,ParameterValue=${PIPELINE_KMS_KEY_ARN} \
                        ParameterKey=Branch,ParameterValue=${BRANCH} \
                        ParameterKey=Stage,ParameterValue=${STAGE} \
                      --capabilities CAPABILITY_NAMED_IAM
                    aws cloudformation wait stack-create-complete --stack-name "pipeline-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}"
                  else
                    aws cloudformation create-change-set \
                      --stack-name "pipeline-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}" \
                      --template-body file://build/pipeline.yaml \
                      --parameters \
                        ParameterKey=RemoteAccount,ParameterValue=${REMOTE_ACCOUNT_ID} \
                        ParameterKey=ArtifactBucket,ParameterValue=${ARTIFACT_BUCKET} \
                        ParameterKey=PipelineKmsKeyArn,ParameterValue=${PIPELINE_KMS_KEY_ARN} \
                        ParameterKey=Branch,ParameterValue=${BRANCH} \
                        ParameterKey=Stage,ParameterValue=${STAGE} \
                      --capabilities CAPABILITY_NAMED_IAM \
                      --change-set-name "pipeline-${CODEBUILD_START_TIME}" > change-set.json
                    CHANGE_SET_ID=$(cat change-set.json | jq -r '.Id')
                    CHANGE_SET=$(aws cloudformation describe-change-set --change-set-name $CHANGE_SET_ID)
                    CHANGE_SET_STATUS=$(echo $CHANGE_SET | jq -r '.Status')
                    if [ $CHANGE_SET_STATUS != "FAILED" ]
                    then
                      aws cloudformation wait change-set-create-complete --change-set-name $CHANGE_SET_ID 
                    fi
                    aws cloudformation describe-change-set --change-set-name $CHANGE_SET_ID > change-set-details.json 
                    CHANGES_COUNT=$(cat change-set-details.json |  jq '.Changes | length')
                    if [ $CHANGES_COUNT = "0" ]
                    then
                      aws cloudformation delete-change-set --change-set-name $CHANGE_SET_ID
                    else
                      aws cloudformation execute-change-set --change-set-name $CHANGE_SET_ID
                      aws cloudformation wait stack-update-complete --stack-name "pipeline-${PROJECT}-${REPOSITORY}-${STAGE}-${BRANCH_NAME}"
                    fi
                  fi
          artifacts:
            base-directory: ${CODEBUILD_SRC_DIR}
            files:
              - change-set-details.json
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:3.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: ARTIFACT_BUCKET
            Value: 
              Fn::ImportValue: !Sub "${BaseStack}:ArtifactBucket"
          - Name: PIPELINE_KMS_KEY_ARN
            Value: 
              Fn::ImportValue: !Sub "${BaseStack}:CodePipelineKmsKeyArn"
          - Name: DEV_OPS_ACCOUNT_ID
            Value: !Ref AWS::AccountId
          - Name: REMOTE_ACCOUNT_ID
            Value: !Ref RemoteAccountTest
      Name: CreateUpdateProjectPipelineBuild
      ServiceRole: !Ref CodeBuildServiceRole
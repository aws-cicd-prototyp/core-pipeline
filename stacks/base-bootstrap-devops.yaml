---
# TODO consistent tagging
# TODO outputs
# CF Stack Deletion and assumed roles
AWSTemplateFormatVersion: 2010-09-09
Description: Cloudformation-Stack for the base pipeline infrastructure. This stack is created in the DevOps Account.

Parameters:
  RemoteAccountTest:
    Description: The remote workload account ID
    Type: String

Resources:
  CodePipelineKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KMS-Key used by code pipelines to enrypt/decrypt the source code in S3"
      EnableKeyRotation: True
      KeyPolicy:
        Version: "2012-10-17"
        Id: !Sub "CodePipelineKey-test"
        Statement:
          - Sid: AdminAccess
            Effect: Allow
            Action:
              - "kms:*"
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Resource: "*" 
          - Sid: Allow usage from workload accounts
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:Encrypt
              - kms:GenerateDataKey
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${RemoteAccountTest}:root"
#            Condition:
#              StringEquals: 
#                "aws:PrincipalTag/Owner": "DevOpsAccount"
#                "aws:PrincipalType": "AssumedRole"
#              "ForAnyValue:StringEquals":
#                "aws:CalledVia": ["cloudformation.amazonaws.com"]
            Resource: "*" 
      Tags:
        - Key: Name
          Value: !Sub "CodePipelineKey-test"
        - Key: Stage
          Value: !Sub "test"
  CodePipelineKmsAlias:
    Type: AWS::KMS::Alias
    DependsOn: CodePipelineKmsKey
    Properties:
      AliasName: !Sub "alias/codepipeline-crossaccount-key-test"
      TargetKeyId: !Ref CodePipelineKmsKey

  ArtifactBucket:
    Type: AWS::S3::Bucket
    DependsOn: CodePipelineKmsAlias
    Properties:
      BucketName: !Join
        - "-"
        - - "codepipeline-artifacts-test"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - "/"
                  - !Ref "AWS::StackId"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              KMSMasterKeyID: !Ref CodePipelineKmsKey
              SSEAlgorithm: 'aws:kms'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration: 
        Status: Enabled
        # TODO Cleanup rules
      Tags:
        - Key: Name
          Value: !Sub "codepipeline-artifacts-test"
        - Key: Stage
          Value: !Sub "test"

  S3BucketPolicy:
    # TODO - Deny manual PUTs
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ArtifactBucket
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetBucketPolicy
              - s3:GetObject
              - s3:ListBucket
              - s3:GetObjectVersion
              - s3:GetBucketVersioning
              - s3:ListBucketVersions
              - s3:GetObjectVersionTagging
            Effect: Allow
            Resource:
              - !Sub 'arn:aws:s3:::${ArtifactBucket}'
              - !Sub 'arn:aws:s3:::${ArtifactBucket}/*'
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${RemoteAccountTest}:root"
#            Condition:
#              StringEquals: 
#                "aws:PrincipalTag/Owner": "DevOpsAccount"
#                "aws:PrincipalType": "AssumedRole"
#              "ForAnyValue:StringEquals":
#                "aws:CalledVia": ["cloudformation.amazonaws.com"]


Outputs:
  ArtifactBucket:
    Description: The S3 Bucket for the artifacts
    Value: !Ref ArtifactBucket
    Export:
      Name: !Sub "${AWS::StackName}:ArtifactBucket"
  CodePipelineKmsKey:
    Description: Pipeline KMS key 
    Value: !Ref CodePipelineKmsKey
    Export:
      Name: !Sub "${AWS::StackName}:CodePipelineKmsKey"
  CodePipelineKmsKeyArn:
    Description: Pipeline KMS key Arn
    Value: !GetAtt CodePipelineKmsKey.Arn
    Export:
      Name: !Sub "${AWS::StackName}:CodePipelineKmsKeyArn"
  CodePipelineKmsAlias:
    Description: Pipeline KMS key alias
    Value: !Ref CodePipelineKmsAlias
    Export:
      Name: !Sub "${AWS::StackName}:CodePipelineKmsAlias"
      